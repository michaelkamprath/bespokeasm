---
name: Release artifacts

'on':
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  wheel:
    name: Build wheel for pipx
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read project metadata
        id: meta
        run: python scripts/read_project_metadata.py
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.meta.outputs.version }}
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
      - name: Build wheel
        run: python -m build --wheel
      - name: Upload wheel to release
        if: github.event_name == 'release' && github.event.action == 'published' && github.actor != 'nektos/act' && env.SKIP_RELEASE_UPLOAD != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.whl
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pyinstaller-linux:
    name: PyInstaller linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read project metadata
        id: meta
        run: python scripts/read_project_metadata.py
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.meta.outputs.version }}
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller
      - name: Build standalone binary
        shell: bash
        run: |
          python -m PyInstaller --onefile --name bespokeasm \
            --distpath dist --collect-all bespokeasm \
            src/bespokeasm/__main__.py
      - name: Rename artifact with platform
        shell: bash
        run: |
          OS_NAME=$(uname -s)
          case "$OS_NAME" in
            Linux*) PLATFORM=linux ;;
            Darwin*) PLATFORM=macos ;;
            MINGW*|MSYS*|CYGWIN*) PLATFORM=windows ;;
            *) PLATFORM=unknown ;;
          esac
          ARCH=$(uname -m)
          EXT=""
          if [ "$PLATFORM" = "windows" ]; then EXT=".exe"; fi
          SRC="dist/bespokeasm${EXT}"
          DEST="dist/bespokeasm-${APP_VERSION}-${PLATFORM}-${ARCH}${EXT}"
          mv "$SRC" "$DEST"
          echo "ASSET_PATH=$DEST" >> "$GITHUB_ENV"
      - name: Upload binary to release
        if: github.event_name == 'release' && github.event.action == 'published' && github.actor != 'nektos/act' && env.SKIP_RELEASE_UPLOAD != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pyinstaller-linux-arm:
    name: PyInstaller linux-arm64
    if: github.actor != 'nektos/act'
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - name: Read project metadata
        id: meta
        run: python scripts/read_project_metadata.py
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.meta.outputs.version }}
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller
      - name: Build standalone binary
        shell: bash
        run: |
          python -m PyInstaller --onefile --name bespokeasm \
            --distpath dist --collect-all bespokeasm \
            src/bespokeasm/__main__.py
      - name: Rename artifact with platform
        shell: bash
        run: |
          OS_NAME=$(uname -s)
          case "$OS_NAME" in
            Linux*) PLATFORM=linux ;;
            Darwin*) PLATFORM=macos ;;
            MINGW*|MSYS*|CYGWIN*) PLATFORM=windows ;;
            *) PLATFORM=unknown ;;
          esac
          ARCH=$(uname -m)
          EXT=""
          if [ "$PLATFORM" = "windows" ]; then EXT=".exe"; fi
          SRC="dist/bespokeasm${EXT}"
          DEST="dist/bespokeasm-${APP_VERSION}-${PLATFORM}-${ARCH}${EXT}"
          mv "$SRC" "$DEST"
          echo "ASSET_PATH=$DEST" >> "$GITHUB_ENV"
      - name: Upload binary to release
        if: github.event_name == 'release' && github.event.action == 'published' && github.actor != 'nektos/act' && env.SKIP_RELEASE_UPLOAD != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pyinstaller-other:
    name: PyInstaller ${{ matrix.os }}
    if: github.actor != 'nektos/act'
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os: [macos-latest, macos-15-intel, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Read project metadata
        id: meta
        run: python scripts/read_project_metadata.py
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.meta.outputs.version }}
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller
      - name: Build standalone binary
        shell: bash
        run: |
          python -m PyInstaller --onefile --name bespokeasm \
            --distpath dist --collect-all bespokeasm \
            src/bespokeasm/__main__.py
      - name: Rename artifact with platform
        shell: bash
        run: |
          OS_NAME=$(uname -s)
          case "$OS_NAME" in
            Linux*) PLATFORM=linux ;;
            Darwin*) PLATFORM=macos ;;
            MINGW*|MSYS*|CYGWIN*) PLATFORM=windows ;;
            *) PLATFORM=unknown ;;
          esac
          ARCH=$(uname -m)
          EXT=""
          if [ "$PLATFORM" = "windows" ]; then EXT=".exe"; fi
          SRC="dist/bespokeasm${EXT}"
          DEST="dist/bespokeasm-${APP_VERSION}-${PLATFORM}-${ARCH}${EXT}"
          mv "$SRC" "$DEST"
          echo "ASSET_PATH=$DEST" >> "$GITHUB_ENV"
      - name: Upload binary to release
        if: github.event_name == 'release' && github.event.action == 'published' && github.actor != 'nektos/act' && env.SKIP_RELEASE_UPLOAD != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
